<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Learn Python Context Managers | Evgeny Roskach's blog</title><meta name=keywords content="python,context manager,decorator,generator,rate limiter,tutorial"><meta name=description content="Originally posted on 2020-04-04
A real problem I encountered While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the API quota limits and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay."><meta name=author content="Evgeny Roskach"><link rel=canonical href=https://genyrosk.github.io/posts/2023-03-05-learn-python-context-managers/><meta name=google-site-verification content="G-9PLC05TT7N"><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://genyrosk.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://genyrosk.github.io/favicon16x16.png><link rel=icon type=image/png sizes=32x32 href=https://genyrosk.github.io/favicon32x32.png><link rel=apple-touch-icon href=https://genyrosk.github.io/apple_touch_icon.png><link rel=mask-icon href=https://genyrosk.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Learn Python Context Managers"><meta property="og:description" content="Originally posted on 2020-04-04
A real problem I encountered While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the API quota limits and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay."><meta property="og:type" content="article"><meta property="og:url" content="https://genyrosk.github.io/posts/2023-03-05-learn-python-context-managers/"><meta property="og:image" content="https://avatars.githubusercontent.com/u/9571838?v4"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-05T22:10:14+09:00"><meta property="article:modified_time" content="2023-03-05T22:10:14+09:00"><meta property="og:site_name" content="genyrosk's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://avatars.githubusercontent.com/u/9571838?v4"><meta name=twitter:title content="Learn Python Context Managers"><meta name=twitter:description content="Originally posted on 2020-04-04
A real problem I encountered While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the API quota limits and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://genyrosk.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Learn Python Context Managers","item":"https://genyrosk.github.io/posts/2023-03-05-learn-python-context-managers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Learn Python Context Managers","name":"Learn Python Context Managers","description":"Originally posted on 2020-04-04\nA real problem I encountered While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the API quota limits and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay.","keywords":["python","context manager","decorator","generator","rate limiter","tutorial"],"articleBody":"Originally posted on 2020-04-04\nA real problem I encountered While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the API quota limits and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay. It was a quick and dirty solution with a lot of boilerplate code, but it worked as a first approach. Later I found myself in the same problem when querying a different API and I realised that a more structured approach was necessary.\nSome time later I found out the existence of the ratelimiter package, and to my surprise: it also used context managers and the code looked very similar! In addition, the package features a very neat usage of the decorator syntax and implements both synchronous and asynchronous versions.\nIn this article we are going to go through the basics of the context manager functionality, and then see it in action when implemented into a rate limiter class.\nThe purpose of context managers The purpose of a context manager is to encapsulate a sequence of “setup” and “teardown” steps into a neat block of code. Any code that runs within that block runs within the context of a particular resource that is created in the process. In the background, a context manager implements this process for you. This process usually involves some sort of creation followed by deletion, an opening followed by closing (of a connection, for example), a building step followed by a breaking step (more metaphors are welcome).\nSounds confusing? Don’t worry, let’s clear it up with some examples.\nExample: Opening a file To open a file in Python you would usually write the follwing:\nf = open('data.txt') text = f.read() print(text) f.close() Hello World Notice the open and close logic.\nThis code is equivalent to the following context manager:\nwith open('data.txt') as f: ## inside the context manager block text = f.read() print(text) ## outside the context manager block Hello World With a context manmager, the user no longer has to explicitely specify the closing step: the context manager does it for you as soon as you start a new line outside the block. Neat.\nBuilding a context manager … … as a class A context manager can be implemented with special class underscore methods, namely __enter__ and __exit__.\nLet’s implement the file reader context manager:\nclass readfile: def __init__(self, file_name, method): self.f = open(file_name, method) def __enter__(self): # Code to acquire resource print('\u003e\u003e __enter__') return self.f def __exit__(self, *args): # __exit__ takes 3 extra arguments that we don't need to worry about # Code to release resource print('\u003e\u003e __exit__') self.f.close() with readfile('data.txt', 'r') as f: text = f.read() print(text) \u003e\u003e __enter__ Hello World \u003e\u003e __exit__ Note how self.f, the resource object, is passed around the class and is ultimately surfaced by the __enter__ method which allows the used to interact with the object inside the block of the context manager.\n…as a generator If you’re familiar with Python generators and the logic you’re writing is simple enough, you can implement a context manager with the generator syntax.\nfrom contextlib import contextmanager @contextmanager def readfile(file_name, method): # Code to acquire resource f = open(file_name, method) try: print('\u003e\u003e yield') yield f finally: # Code to release resource print('\u003e\u003e finally') f.close() with readfile('data.txt', 'r') as f: text = f.read() print(text) \u003e\u003e yield Hello World \u003e\u003e finally This syntax looks much simpler by using the contextmanager function to decorate the generator and convert it into a context manager. In the background this decorator implements the __enter__ and __exit__ methods for us so we don’t have to worry about them. All we need is a try ... finally logic.\nThe request limiter A simulated API Let’s simulate an API behaviour with the following generator, which normally returns a 200 OK message when everything is ok, but will return an 403 Quota Exceeded error message if a pre-defined quota limit has been exceeded. We will interface with the API generator using an intermediary call_api function to make things easier on the user side code.\nimport time def API(ping=0.15): limit = 5 # allow up to 5 calls ... period = 1.0 # ... per second calls = [] while True: time.sleep(ping) # simulate response delay now = time.time() call_window = [t for t in calls if now - t \u003c period] if len(call_window) \u003c limit: calls = call_window + [now] yield '200 OK' else: yield '403 Quota Exceeded' api = API() def call_api(): return next(api) Now if we simulate this API object with very rapid calls, we should get an error message back once we exceed the quota of 5 calls per second.\nstart = time.time() for i in range(10): result = call_api() print(f'second [{time.time() - start:.2f}] call [{i}]: {result}') second [0.15] call [0]: 200 OK second [0.31] call [1]: 200 OK second [0.46] call [2]: 200 OK second [0.62] call [3]: 200 OK second [0.77] call [4]: 200 OK second [0.92] call [5]: 403 Quota Exceeded second [1.07] call [6]: 403 Quota Exceeded second [1.22] call [7]: 200 OK second [1.37] call [8]: 200 OK second [1.52] call [9]: 200 OK But if we introduce a long enough delay between the calls, the API will no longer respond with a 403 error message.\nstart = time.time() for i in range(10): time.sleep(0.2) result = call_api() print(f'second [{time.time() - start:.2f}] call [{i}]: {result}') second [0.35] call [0]: 200 OK second [0.71] call [1]: 200 OK second [1.07] call [2]: 200 OK second [1.43] call [3]: 200 OK second [1.79] call [4]: 200 OK second [2.15] call [5]: 200 OK second [2.50] call [6]: 200 OK second [2.86] call [7]: 200 OK second [3.21] call [8]: 200 OK second [3.57] call [9]: 200 OK However, this is far from ideal, since we’re stuck introducing delays into our code. What we actually would like to do is to be able to call the API as soon as the quota window has passed. We need to keep track of the request times and throttle our own calls.\nFirst attempt: function wrapper Let’s start with a function wrapper. Say we need to call the API an arbitrary number of times.\ndef request_limiter(n, max_calls, period=1.0): results = [] calls = [] # call the api n times for _ in range(n): # Sleep cycle logic: # if we're exceeding the limit ... if len(calls) \u003e= max_calls: # calculate the minimum sleeping time sleeptime = period - calls[-1] + calls[0] if sleeptime \u003e 0: # and wait time.sleep(sleeptime) # API call result = call_api() results += [result] # keep track of calls within the time window now = time.time() calls += [now] calls = [t for t in calls if now - t \u003c period] return results results = request_limiter(10, 5) for i, result in enumerate(results): print(f'call [{i}]: {result}') call [0]: 200 OK call [1]: 200 OK call [2]: 200 OK call [3]: 200 OK call [4]: 200 OK call [5]: 200 OK call [6]: 200 OK call [7]: 200 OK call [8]: 200 OK call [9]: 200 OK Improved version: as a decorator The main limitation of the simple functional implementation above is that we have to provide to it the number of times that we want to query the API in order to be able to then keep a memory of the state inside the function. What if we don’t know how many times we need to call the API? What if these calls come from different places?\nWe need to keep track of the calls that we’re making dynamically, i.e. the state needs to live outside of the function making the calls: a stateful decorator.\nAlthough stateful decorators can be implemented using the function itself as the object state, it’s much more intelligible to implement it in a classic class structure.\nimport time from functools import wraps class RequestLimiter: def __init__(self, max_calls, period=1.0): self.max_calls = max_calls # number of calls limit self.period = period # time window self.calls = [] def __call__(self, f): @wraps(f) def wrapper(*args, **kwargs): # Sleep cycle if len(self.calls) \u003e= self.max_calls: sleeptime = self.period - self._timespan if sleeptime \u003e 0: time.sleep(sleeptime) # function call rv = f(*args, **kwargs) # `rv` = return value # keep track of calls within the time window now = time.time() self.calls += [now] self.calls = [t for t in self.calls if now - t \u003c self.period] return rv return wrapper @property def _timespan(self): return self.calls[-1] - self.calls[0] @RequestLimiter(5) def call_api_throttled(): return call_api() start = time.time() for i in range(10): result = call_api_throttled() print(f'second [{time.time() - start:.2f}] call [{i}]: {result}') second [0.15] call [0]: 200 OK second [0.31] call [1]: 200 OK second [0.46] call [2]: 200 OK second [0.61] call [3]: 200 OK second [0.77] call [4]: 200 OK second [1.31] call [5]: 200 OK second [1.46] call [6]: 200 OK second [1.62] call [7]: 200 OK second [1.77] call [8]: 200 OK second [1.92] call [9]: 200 OK The context manager version In this particular context manager implementation, the context lives outside of the with block. However: every time we enter the with block we’re back again inside the same context and the same state as when we left. Thus, the context manager keeps track of the state outside of the with block and enforces the required behaviour when we enter the with block.\nimport time from functools import wraps class RequestLimiter: def __init__(self, max_calls, period=1.0): self.max_calls = max_calls # number of calls limit self.period = period # time window self.calls = [] def __enter__(self): # Sleep cycle if len(self.calls) \u003e= self.max_calls: sleeptime = self.period - self._timespan if sleeptime \u003e 0: time.sleep(sleeptime) return self def __exit__(self, exc_type, exc_val, exc_tb): # keep track of calls within the time window now = time.time() self.calls += [now] self.calls = [t for t in self.calls if now - t \u003c self.period] @property def _timespan(self): return self.calls[-1] - self.calls[0] limiter = RequestLimiter(5) # the state lives outside of the function calls start = time.time() for i in range(10): with limiter: # \u003e\u003e\u003e\u003e\u003e we enter the context manager's state \u003c\u003c\u003c\u003c\u003c # ------------------------------------------------ # based on its state, the context manager decides # when to to execute the code inside the block result = call_api() print(f'second [{time.time() - start:.2f}] call [{i}]: {result}') second [0.15] call [0]: 200 OK second [0.31] call [1]: 200 OK second [0.46] call [2]: 200 OK second [0.61] call [3]: 200 OK second [0.76] call [4]: 200 OK second [1.31] call [5]: 200 OK second [1.46] call [6]: 200 OK second [1.61] call [7]: 200 OK second [1.76] call [8]: 200 OK second [1.92] call [9]: 200 OK Adding decorator syntax support We can add decorator syntax support with a simple modification of the __call__ method, just as we did before. However, this time we don ’t need to implement the entire logic again: simply make use of the context manager logic within the decorator.\nimport time from functools import wraps class RequestLimiter: def __init__(self, max_calls, period=1.0): self.max_calls = max_calls # number of calls limit self.period = period # time window self.calls = [] def __call__(self, f): @wraps(f) def wrapper(*args, **kwargs): with self: return f(*args, **kwargs) return wrapper def __enter__(self): # Sleep cycle if len(self.calls) \u003e= self.max_calls: sleeptime = self.period - self._timespan if sleeptime \u003e 0: time.sleep(sleeptime) return self def __exit__(self, exc_type, exc_val, exc_tb): # keep track of calls within the time window now = time.time() self.calls += [now] self.calls = [t for t in self.calls if now - t \u003c self.period] @property def _timespan(self): return self.calls[-1] - self.calls[0] This is as simple and elegant as it gets.\nLet’s take this decorator for a spin.\n@RequestLimiter(5) def call_api_throttled(): return call_api() start = time.time() for i in range(10): result = call_api_throttled() print(f'second [{time.time() - start:.2f}] call [{i}]: {result}') second [0.15] call [0]: 200 OK second [0.31] call [1]: 200 OK second [0.46] call [2]: 200 OK second [0.61] call [3]: 200 OK second [0.77] call [4]: 200 OK second [1.31] call [5]: 200 OK second [1.47] call [6]: 200 OK second [1.62] call [7]: 200 OK second [1.77] call [8]: 200 OK second [1.93] call [9]: 200 OK Same as before.\nThank you for reading!\n","wordCount":"2050","inLanguage":"en","datePublished":"2023-03-05T22:10:14+09:00","dateModified":"2023-03-05T22:10:14+09:00","author":{"@type":"Person","name":"Evgeny Roskach"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://genyrosk.github.io/posts/2023-03-05-learn-python-context-managers/"},"publisher":{"@type":"Organization","name":"Evgeny Roskach's blog","logo":{"@type":"ImageObject","url":"https://genyrosk.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://genyrosk.github.io/ accesskey=h title="Ev's stdout (Alt + H)"><img src=https://avatars.githubusercontent.com/u/9571838?v4 alt aria-label=logo height=35>Ev's stdout</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://genyrosk.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://genyrosk.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Learn Python Context Managers</h1><div class=post-meta><span title='2023-03-05 22:10:14 +0900 +0900'>March 5, 2023</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Evgeny Roskach&nbsp;|&nbsp;<a href=https://github.com/genyrosk/genyrosk.github.io/tree/main/content//posts/python-context-managers/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#a-real-problem-i-encountered>A real problem I encountered</a></li><li><a href=#the-purpose-of-context-managers>The purpose of context managers</a><ul><li><a href=#example-opening-a-file>Example: Opening a file</a></li></ul></li><li><a href=#building-a-context-manager->Building a context manager &mldr;</a><ul><li><a href=#-as-a-class>&mldr; as a class</a></li><li><a href=#as-a-generator>&mldr;as a generator</a></li></ul></li><li><a href=#the-request-limiter>The request limiter</a><ul><li><a href=#a-simulated-api>A simulated API</a></li><li><a href=#first-attempt-function-wrapper>First attempt: function wrapper</a></li><li><a href=#improved-version-as-a-decorator>Improved version: as a decorator</a></li><li><a href=#the-context-manager-version>The context manager version</a></li><li><a href=#adding-decorator-syntax-support>Adding decorator syntax support</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p><em>Originally posted on 2020-04-04</em></p><h2 id=a-real-problem-i-encountered>A real problem I encountered<a hidden class=anchor aria-hidden=true href=#a-real-problem-i-encountered>#</a></h2><p>While learning to use Python Context Managers, I encountered a neat use case for them. At the time I was writing a data pipeline that was heavily querying an API and I would often quickly reach the <strong>API quota limits</strong> and the script would abruptly quit. My initial solution was to catch the exception and implement a loop that would try again after a time delay. It was a quick and dirty solution with a lot of boilerplate code, but it worked as a first approach. Later I found myself in the same problem when querying a different API and I realised that a more structured approach was necessary.</p><p>Some time later I found out the existence of the <a href=https://github.com/RazerM/ratelimiter>ratelimiter</a> package, and to my surprise: it also used context managers and the code looked very similar! In addition, the package features a very neat usage of the decorator syntax and implements both synchronous and asynchronous versions.</p><p>In this article we are going to go through the <strong>basics of the context manager functionality</strong>, and then see it in action when implemented into a rate limiter class.</p><h2 id=the-purpose-of-context-managers>The purpose of context managers<a hidden class=anchor aria-hidden=true href=#the-purpose-of-context-managers>#</a></h2><p>The purpose of a context manager is to encapsulate a sequence of &ldquo;setup&rdquo; and &ldquo;teardown&rdquo; steps into a neat block of code. Any code that runs within that block runs within the context of a particular resource that is created in the process. In the background, a context manager implements this process for you. This process usually involves some sort of creation followed by deletion, an opening followed by closing (of a connection, for example), a building step followed by a breaking step (more metaphors are welcome).</p><p>Sounds confusing? Don&rsquo;t worry, let&rsquo;s clear it up with some examples.</p><h3 id=example-opening-a-file>Example: Opening a file<a hidden class=anchor aria-hidden=true href=#example-opening-a-file>#</a></h3><p>To open a file in Python you would usually write the follwing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>text</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Hello World
</span></span></code></pre></div><p>Notice the <code>open</code> and <code>close</code> logic.</p><p>This code is equivalent to the following context manager:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>## inside the context manager block </span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>## outside the context manager block </span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Hello World
</span></span></code></pre></div><p>With a context manmager, the user no longer has to explicitely specify the closing step: the context manager does it for you as soon as you start a new line outside the block. Neat.</p><h2 id=building-a-context-manager->Building a context manager &mldr;<a hidden class=anchor aria-hidden=true href=#building-a-context-manager->#</a></h2><h3 id=-as-a-class>&mldr; as a class<a hidden class=anchor aria-hidden=true href=#-as-a-class>#</a></h3><p>A context manager can be implemented with special class underscore methods, namely <code>__enter__</code> and <code>__exit__</code>.</p><p>Let&rsquo;s implement the file reader context manager:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>readfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Code to acquire resource</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&gt;&gt; __enter__&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span> <span class=c1># __exit__ takes 3 extra arguments that we don&#39;t need to worry about</span>
</span></span><span class=line><span class=cl>        <span class=c1># Code to release resource</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&gt;&gt; __exit__&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>readfile</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt;&gt; __enter__
</span></span><span class=line><span class=cl>Hello World
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt;&gt; __exit__
</span></span></code></pre></div><p>Note how <code>self.f</code>, the resource object, is passed around the class and is ultimately surfaced by the <code>__enter__</code> method which allows the used to interact with the object inside the block of the context manager.</p><h3 id=as-a-generator>&mldr;as a generator<a hidden class=anchor aria-hidden=true href=#as-a-generator>#</a></h3><p>If you&rsquo;re familiar with Python generators and the logic you&rsquo;re writing is simple enough, you can implement a context manager with the generator syntax.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>readfile</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Code to acquire resource</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&gt;&gt; yield&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>f</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Code to release resource</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&gt;&gt; finally&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>readfile</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt;&gt; yield
</span></span><span class=line><span class=cl>Hello World
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt;&gt; finally
</span></span></code></pre></div><p>This syntax looks much simpler by using the <code>contextmanager</code> function to decorate the generator and convert it into a context manager. In the background this decorator implements the <code>__enter__</code> and <code>__exit__</code> methods for us so we don&rsquo;t have to worry about them. All we need is a <code>try ... finally</code> logic.</p><h2 id=the-request-limiter>The request limiter<a hidden class=anchor aria-hidden=true href=#the-request-limiter>#</a></h2><h3 id=a-simulated-api>A simulated API<a hidden class=anchor aria-hidden=true href=#a-simulated-api>#</a></h3><p>Let&rsquo;s simulate an API behaviour with the following generator, which normally returns a <code>200 OK</code> message when everything is ok, but will return an <code>403 Quota Exceeded</code> error message if a pre-defined quota limit has been exceeded. We will interface with the API generator using an intermediary <code>call_api</code> function to make things easier on the user side code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span> 
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>API</span><span class=p>(</span><span class=n>ping</span><span class=o>=</span><span class=mf>0.15</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span> <span class=o>=</span> <span class=mi>5</span>    <span class=c1># allow up to 5 calls ...</span>
</span></span><span class=line><span class=cl>    <span class=n>period</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=c1># ... per second</span>
</span></span><span class=line><span class=cl>    <span class=n>calls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>ping</span><span class=p>)</span> <span class=c1># simulate response delay </span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>call_window</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>calls</span> <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>call_window</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>limit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>calls</span> <span class=o>=</span> <span class=n>call_window</span> <span class=o>+</span> <span class=p>[</span><span class=n>now</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;200 OK&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;403 Quota Exceeded&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>api</span> <span class=o>=</span> <span class=n>API</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>call_api</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>next</span><span class=p>(</span><span class=n>api</span><span class=p>)</span>
</span></span></code></pre></div><p>Now if we simulate this API object with very rapid calls, we should get an error message back once we exceed the quota of 5 calls per second.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;second [</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>] call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>second <span class=o>[</span>0.15<span class=o>]</span> call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.31<span class=o>]</span> call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.46<span class=o>]</span> call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.62<span class=o>]</span> call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.77<span class=o>]</span> call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.92<span class=o>]</span> call <span class=o>[</span>5<span class=o>]</span>: <span class=m>403</span> Quota Exceeded
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.07<span class=o>]</span> call <span class=o>[</span>6<span class=o>]</span>: <span class=m>403</span> Quota Exceeded
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.22<span class=o>]</span> call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.37<span class=o>]</span> call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.52<span class=o>]</span> call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><p>But if we introduce a long enough delay between the calls, the API will no longer respond with a <code>403</code> error message.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;second [</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>] call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>second <span class=o>[</span>0.35<span class=o>]</span> call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.71<span class=o>]</span> call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.07<span class=o>]</span> call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.43<span class=o>]</span> call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.79<span class=o>]</span> call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>2.15<span class=o>]</span> call <span class=o>[</span>5<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>2.50<span class=o>]</span> call <span class=o>[</span>6<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>2.86<span class=o>]</span> call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>3.21<span class=o>]</span> call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>3.57<span class=o>]</span> call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><p>However, this is far from ideal, since we&rsquo;re stuck introducing delays into our code. What we actually would like to do is to be able to call the API as soon as the quota window has passed. We need to keep track of the request times and throttle our own calls.</p><h3 id=first-attempt-function-wrapper>First attempt: function wrapper<a hidden class=anchor aria-hidden=true href=#first-attempt-function-wrapper>#</a></h3><p>Let&rsquo;s start with a function wrapper. Say we need to call the API an arbitrary number of times.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_limiter</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>max_calls</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>calls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># call the api n times</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Sleep cycle logic:</span>
</span></span><span class=line><span class=cl>        <span class=c1># if we&#39;re exceeding the limit ...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>calls</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># calculate the minimum sleeping time</span>
</span></span><span class=line><span class=cl>            <span class=n>sleeptime</span> <span class=o>=</span> <span class=n>period</span> <span class=o>-</span> <span class=n>calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>calls</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sleeptime</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># and wait</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleeptime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># API call </span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>+=</span> <span class=p>[</span><span class=n>result</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># keep track of calls within the time window</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>calls</span> <span class=o>+=</span> <span class=p>[</span><span class=n>now</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>calls</span> <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>request_limiter</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>result</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>5<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>6<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><h3 id=improved-version-as-a-decorator>Improved version: as a decorator<a hidden class=anchor aria-hidden=true href=#improved-version-as-a-decorator>#</a></h3><p>The main limitation of the simple functional implementation above is that we have to provide to it the number of times that we want to query the API in order to be able to then keep a memory of the state inside the function. What if we don&rsquo;t know how many times we need to call the API? What if these calls come from different places?</p><p>We need to keep track of the calls that we&rsquo;re making dynamically, i.e. the state needs to live outside of the function making the calls: a stateful decorator.</p><p>Although stateful decorators can be implemented using the function itself as the <a href=https://realpython.com/primer-on-python-decorators/#stateful-decorators>object state</a>, it&rsquo;s much more intelligible to implement it in a classic class structure.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_calls</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span> <span class=o>=</span> <span class=n>max_calls</span> <span class=c1># number of calls limit</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>=</span> <span class=n>period</span>       <span class=c1># time window </span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>f</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Sleep cycle </span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sleeptime</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timespan</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>sleeptime</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleeptime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># function call </span>
</span></span><span class=line><span class=cl>            <span class=n>rv</span> <span class=o>=</span> <span class=n>f</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span> <span class=c1># `rv` = return value</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># keep track of calls within the time window</span>
</span></span><span class=line><span class=cl>            <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>+=</span> <span class=p>[</span><span class=n>now</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>rv</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_timespan</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@RequestLimiter</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>call_api_throttled</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>call_api_throttled</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;second [</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>] call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>second <span class=o>[</span>0.15<span class=o>]</span> call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.31<span class=o>]</span> call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.46<span class=o>]</span> call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.61<span class=o>]</span> call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.77<span class=o>]</span> call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.31<span class=o>]</span> call <span class=o>[</span>5<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.46<span class=o>]</span> call <span class=o>[</span>6<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.62<span class=o>]</span> call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.77<span class=o>]</span> call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.92<span class=o>]</span> call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><h3 id=the-context-manager-version>The context manager version<a hidden class=anchor aria-hidden=true href=#the-context-manager-version>#</a></h3><p>In this particular context manager implementation, the context lives outside of the <code>with</code> block. However: every time we enter the <code>with</code> block we&rsquo;re back again inside the same context and the same state as when we left. Thus, the context manager keeps track of the state outside of the <code>with</code> block and enforces the required behaviour when we enter the <code>with</code> block.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_calls</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span> <span class=o>=</span> <span class=n>max_calls</span> <span class=c1># number of calls limit</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>=</span> <span class=n>period</span>       <span class=c1># time window </span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Sleep cycle </span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sleeptime</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timespan</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sleeptime</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleeptime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># keep track of calls within the time window</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>+=</span> <span class=p>[</span><span class=n>now</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_timespan</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>limiter</span> <span class=o>=</span> <span class=n>RequestLimiter</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span> <span class=c1># the state lives outside of the function calls </span>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>limiter</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>        <span class=c1># &gt;&gt;&gt;&gt;&gt; we enter the context manager&#39;s state &lt;&lt;&lt;&lt;&lt;</span>
</span></span><span class=line><span class=cl>        <span class=c1># ------------------------------------------------</span>
</span></span><span class=line><span class=cl>        <span class=c1># based on its state, the context manager decides</span>
</span></span><span class=line><span class=cl>        <span class=c1># when to to execute the code inside the block </span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;second [</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>] call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>second <span class=o>[</span>0.15<span class=o>]</span> call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.31<span class=o>]</span> call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.46<span class=o>]</span> call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.61<span class=o>]</span> call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.76<span class=o>]</span> call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.31<span class=o>]</span> call <span class=o>[</span>5<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.46<span class=o>]</span> call <span class=o>[</span>6<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.61<span class=o>]</span> call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.76<span class=o>]</span> call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.92<span class=o>]</span> call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><h3 id=adding-decorator-syntax-support>Adding decorator syntax support<a hidden class=anchor aria-hidden=true href=#adding-decorator-syntax-support>#</a></h3><p>We can add decorator syntax support with a simple modification of the <code>__call__</code> method, just as we did before. However, this time we don &rsquo;t need to implement the entire logic again: simply make use of the context manager logic within the decorator.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_calls</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span> <span class=o>=</span> <span class=n>max_calls</span> <span class=c1># number of calls limit</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>=</span> <span class=n>period</span>       <span class=c1># time window </span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>f</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>f</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Sleep cycle </span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sleeptime</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timespan</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sleeptime</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleeptime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># keep track of calls within the time window</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>+=</span> <span class=p>[</span><span class=n>now</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>period</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_timespan</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> 
</span></span></code></pre></div><p>This is as simple and elegant as it gets.</p><p>Let&rsquo;s take this decorator for a spin.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@RequestLimiter</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>call_api_throttled</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>call_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>call_api_throttled</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;second [</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>] call [</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>]: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>second <span class=o>[</span>0.15<span class=o>]</span> call <span class=o>[</span>0<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.31<span class=o>]</span> call <span class=o>[</span>1<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.46<span class=o>]</span> call <span class=o>[</span>2<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.61<span class=o>]</span> call <span class=o>[</span>3<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>0.77<span class=o>]</span> call <span class=o>[</span>4<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.31<span class=o>]</span> call <span class=o>[</span>5<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.47<span class=o>]</span> call <span class=o>[</span>6<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.62<span class=o>]</span> call <span class=o>[</span>7<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.77<span class=o>]</span> call <span class=o>[</span>8<span class=o>]</span>: <span class=m>200</span> OK
</span></span><span class=line><span class=cl>second <span class=o>[</span>1.93<span class=o>]</span> call <span class=o>[</span>9<span class=o>]</span>: <span class=m>200</span> OK
</span></span></code></pre></div><p>Same as before.</p><p>Thank you for reading!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://genyrosk.github.io/tags/python/>python</a></li><li><a href=https://genyrosk.github.io/tags/context-manager/>context manager</a></li><li><a href=https://genyrosk.github.io/tags/decorator/>decorator</a></li><li><a href=https://genyrosk.github.io/tags/generator/>generator</a></li><li><a href=https://genyrosk.github.io/tags/rate-limiter/>rate limiter</a></li><li><a href=https://genyrosk.github.io/tags/tutorial/>tutorial</a></li></ul><nav class=paginav><a class=next href=https://genyrosk.github.io/posts/2023-03-05-learn-python-decorators/><span class=title>Next »</span><br><span>Learn Python Decorators</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on twitter" href="https://twitter.com/intent/tweet/?text=Learn%20Python%20Context%20Managers&amp;url=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f&amp;hashtags=python%2ccontextmanager%2cdecorator%2cgenerator%2cratelimiter%2ctutorial"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f&amp;title=Learn%20Python%20Context%20Managers&amp;summary=Learn%20Python%20Context%20Managers&amp;source=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f&title=Learn%20Python%20Context%20Managers"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on whatsapp" href="https://api.whatsapp.com/send?text=Learn%20Python%20Context%20Managers%20-%20https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Learn Python Context Managers on telegram" href="https://telegram.me/share/url?text=Learn%20Python%20Context%20Managers&amp;url=https%3a%2f%2fgenyrosk.github.io%2fposts%2f2023-03-05-learn-python-context-managers%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://genyrosk.github.io/>Evgeny Roskach's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>